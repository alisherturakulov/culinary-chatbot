<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name = "viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./chatbot-styles.css">
    </head>
    <body>
        <div class="chatBotBox">
            <!--<input type="checkbox" class="chatBotTab" name="chatBotTab">
                Open Chatbot-->
            <div class="chatBotTab">
                Open Chatbot
            </div>
            <div class="chatBotMessageBox">
                <p class="botMessage">
                    Hello, ask me any questions about Culinary Argan Oil!
                </p>
                <!-- class= "userMessage" for user-->
            </div>
            <div class="chatBotInputBox">
                <input type="text" name="chatBotInput" class="chatBotInput" placeholder="Example: what are the benefits of Argan Oil?">

                </input>
                <button class="chatBotButton"  type="button" onclick="getAnswer()">
                    Enter
                </button>
            </div>
        </div>
        <div>
            <h1>
                Placeholder Heading; this is a sample page
            </h1>
            <p>
                Click on "Open Chatbot" to bring the chat UI into view
            </p>
        </div>
        <script class="chatBoxMoveScript" async="false" defer>
            let chatBoxTab = document.querySelector(".chatBotTab");
            chatBoxTab.addEventListener("click", toggleChatBox);
            const clickEvent = new Event("click");
            chatBoxTab.dispatchEvent(clickEvent);
          

            //function definitions
            /**
             * adds/removes the openedChatBox class from styles to make the chatBox
             * visible or not
             */
            function toggleChatBox(){
                const chatBox = document.querySelector(".chatBotBox");
                chatBox.classList.toggle("openChatBox");
                const tab = document.querySelector(".chatBotTab");
                let tabText = tab.textContent;

                if(tabText.trim().includes("Open")){
                    tabText = "Close Chatbot";
                }else{
                    tabText = "Open Chatbot";
                }
                tab.textContent = tabText;
                //console.log("openedChatBox");
            }

            /**
             * calls posUserMessage and adds answer as a message
            */
            async function getAnswer(){
                const button = document.querySelector(".chatBotButton");
                button.setAttribute("onclick", "");
                //console.log("button onclick after click: " + button.getAttribute("onclick"));
                //button.setAttribute("hidden", "true");
                postUserMessage().then((ans) =>{
                    addBotMessage(ans);
                }).catch((err) =>{
                    addBotMessage("Error: " + err.message);
                    console.error("error in getAnswer: " +err.message);
                }).finally(() =>{//to prevent spam
                    button.setAttribute("onclick", "getAnswer()");
                });    
            }

            /**
             * adds the question to the messageList and sends a request to the backend
             * @see addUserMessage
            */
            async function postUserMessage(){
                const userInputField = document.querySelector(".chatBotInput");
                const questionText = userInputField.value;
                //console.log(questionText + "passed");
                if(questionText == ""){
                    console.error("error; question not given");
                    return "Error; please enter a valid question";
                }
                addUserMessage(questionText);
                //next send a request to the backend script
                const url = new URL("http://127.0.0.1:3000/");
                try{
                    const response = await fetch(url, {
                        method:"POST",
                        /*headers:{
                            'Content-Type':'text/plain'
                        },*/
                        body: questionText,
                        //credentials:"include",//to include cookies in req headers
                        
                    }); 
                    if(!response.ok){
                        throw new Error("response not ok: " + response.status);
                        
                    }        
                    
                    const answer = await response.text(); 
                    //console.log("answer is: " + answer);
                    return answer;
                    

                }catch(err){
                    console.error("Error in postM: "+ err.message);
                    throw err;
                    //return;
                }
            }

            /**
             * adds a p element as a user message to the chat
             * param {string} questionText
            */
            function addUserMessage(questionText){
                const userMessage= document.createElement("p");
                userMessage.classList.add("userMessage");
                userMessage.textContent = questionText;
                //console.log(userMessage.textContent);
                const messageList = document.querySelector(".chatBotMessageBox");
                messageList.lastChild.after(userMessage);
                //console.log(messageList.lastChild.textContent);
            }

            /**
             * Adds a bot message with the given text
             * param {string} answerText
            */
            function addBotMessage(answerText){
                //console.log("adding bot message: " + answerText);
                const botMessage = document.createElement("p");
                botMessage.classList.add("botMessage");
                botMessage.textContent = answerText;
                const messageList = document.querySelector(".chatBotMessageBox");
                messageList.appendChild(botMessage);
            }
        </script>
    </body>
</html>
